<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Perfil de Usuario</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        .perfil-box {
            background: #fff;
            padding: 25px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            max-width: 600px;
            margin: 40px auto;
        }
        .perfil-box h2 {
            text-align: center;
        }
        .perfil-datos p {
            display: flex;
            align-items: center;
            margin: 8px 0;
            margin-bottom: 2rem;
        }
        .perfil-datos strong {
            width: 180px;
            display: inline-block;
        }
        .btn-edit {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            max-width: fit-content;
            margin: auto;
            align-items: end;
        }
        .btn-edit img {
            width: 16px;
            height: 16px;
        }
        .btn-eliminar {
            display: block;
            margin: 20px auto 0;
            background-color: #cc0000;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-eliminar:hover {
            background-color: #990000;
        }
        input.inline-input {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            max-width: 250px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .error {
            color: #cc0000;
            text-align: center;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 100px auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }
        .modal-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .modal-option {
            flex: 1 0 200px;
        }
        .modal-option label {
            display: block;
            margin-bottom: 5px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
        }
    </style>
</head>
<body>
    <nav class="menu">
        <div class="menu-center">
            <a href="inicio.html">Inicio</a>
            <a href="perfil.html" class="active">Perfil</a>
            <a href="companieros.html">Compañeros</a>
        </div>
        <a href="index.html" id="logoutBtn" class="logout-btn">Cerrar sesión</a>
    </nav>

    <div class="perfil-box">
        <h2>Perfil de Usuario</h2>
        <div class="perfil-datos" id="datosUsuario">
            <p class="loading">Cargando datos del perfil...</p>
        </div>
        <button class="btn-eliminar" id="eliminarPerfil">Eliminar Perfil</button>
    </div>

    <!-- Modal para editar materias y carreras -->
    <div id="modalEdicion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitulo">Editar</h3>
                <button class="modal-close" id="modalCerrar">&times;</button>
            </div>
            <div id="modalOpciones" class="modal-options"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modalCancelar">Cancelar</button>
                <button class="btn btn-primary" id="modalGuardar">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // =======================
        // Configuración inicial
        // =======================
        const BASE_URL = "http://localhost:8080/api";
        const legajoUsuario = localStorage.getItem("legajo");
        let datos = {};
        let codigos = {
            carreras: [],
            materiasCursa: [],
            materiasAprobadas: []
        };
        let opcionesDisponibles = {
            carreras: [],
            materias: []
        };
        let campoEditando = null;

        // Campos editables
        const camposEditables = [
            { key: "nombre", label: "Nombre completo" },
            { key: "fechaNacimiento", label: "Fecha de nacimiento" },
            { key: "contacto", label: "Datos de contacto" },
            { key: "correoUni", label: "Correo de la universidad" }
        ];

        // Campos inmutables
        const camposInmutables = [
            { key: "legajo", label: "Legajo" },
            { key: "dni", label: "DNI" }
        ];

        // Campos especiales (materias)
        const camposEspeciales = [
            { key: "carreras", label: "Carreras" },
            { key: "materiasCursa", label: "Materias que cursa" },
            { key: "materiasAprobadas", label: "Materias aprobadas" }
        ];

        // Elementos del modal
        const modal = document.getElementById('modalEdicion');
        const modalTitulo = document.getElementById('modalTitulo');
        const modalOpciones = document.getElementById('modalOpciones');
        const modalGuardar = document.getElementById('modalGuardar');
        const modalCancelar = document.getElementById('modalCancelar');
        const modalCerrar = document.getElementById('modalCerrar');

        // =======================
        // Funciones de traducción
        // =======================
        async function traducirCodigos(tipo, codigosStr) {
            if (!codigosStr) return [];
            const codigos = codigosStr.split(',');
            if (codigos.length === 0) return [];
            
            try {
                const codigosParam = codigos.join(',');
                const response = await fetch(`${BASE_URL}/translate/${tipo}?codigos=${codigosParam}`, {
                    method: "GET"
                });
                
                if (!response.ok) {
                    throw new Error("Error traduciendo códigos");
                }
                
                return response.json();
            } catch (error) {
                console.error("Error en traducción:", error);
                return codigos;
            }
        }

        // =======================
        // Cargar opciones disponibles
        // =======================
        async function cargarOpcionesDisponibles() {
            try {
                // Cargar carreras
                const carrerasResponse = await fetch(`${BASE_URL}/translate/all/carreras`);
                if (!carrerasResponse.ok) throw new Error('Error cargando carreras');
                opcionesDisponibles.carreras = await carrerasResponse.json();
                
                // Cargar materias
                const materiasResponse = await fetch(`${BASE_URL}/translate/all/materias`);
                if (!materiasResponse.ok) throw new Error('Error cargando materias');
                opcionesDisponibles.materias = await materiasResponse.json();
                
            } catch (error) {
                console.error("Error cargando opciones:", error);
            }
        }

        // =======================
        // Renderizar perfil
        // =======================
        async function renderPerfil() {
            let html = "";
            
            // Campos inmutables
            camposInmutables.forEach((campo) => {
                html += `
                    <p>
                        <strong>${campo.label}:</strong>
                        <span>${datos[campo.key] || ""}</span>
                    </p>
                `;
            });
            
            // Campos editables
            camposEditables.forEach((campo) => {
                html += `
                    <p>
                        <strong>${campo.label}:</strong>
                        <span id="valor-${campo.key}">${datos[campo.key] || ""}</span>
                        <button class="btn-edit" onclick="activarEdicion('${campo.key}')">
                            <img src="pencil-line.png" alt="Editar">
                        </button>
                    </p>
                `;
            });
            
            // Campos especiales (materias)
            camposEspeciales.forEach((campo) => {
                html += `
                    <p>
                        <strong>${campo.label}:</strong>
                        <span id="valor-${campo.key}">${datos[campo.key] || ""}</span>
                        <button class="btn-edit" onclick="editarEspecial('${campo.key}')">
                            <img src="pencil-line.png" alt="Editar">
                        </button>
                    </p>
                `;
            });
            
            document.getElementById("datosUsuario").innerHTML = html;
        }

        // =======================
        // Activar edición en línea
        // =======================
        function activarEdicion(campo) {
            const span = document.getElementById(`valor-${campo}`);
            const valorActual = datos[campo] || "";
            span.innerHTML = `<input type="text" class="inline-input" value="${valorActual}" 
                                onblur="guardarCambio('${campo}', this.value)" 
                                onkeypress="if(event.key==='Enter'){this.blur();}">`;
            span.querySelector("input").focus();
        }

        // =======================
        // Editar campos especiales
        // =======================
        function editarEspecial(campo) {
            campoEditando = campo;
            modalTitulo.textContent = `Editar ${campo}`;
            
            // Determinar tipo de opciones (carreras o materias)
            const tipo = campo === 'carreras' ? 'carreras' : 'materias';
            const opciones = tipo === 'carreras' ? 
                opcionesDisponibles.carreras : 
                opcionesDisponibles.materias;
            
            // Obtener códigos seleccionados actualmente
            const seleccionados = codigos[campo] || [];
            
            // Construir opciones
            modalOpciones.innerHTML = '';
            opciones.forEach(opcion => {
                const codigo = tipo === 'carreras' ? opcion.codigoCarrera : opcion.codigoMateria;
                const nombre = tipo === 'carreras' ? opcion.nombreCarrera : opcion.nombreMateria;
                
                const div = document.createElement('div');
                div.className = 'modal-option';
                div.innerHTML = `
                    <label>
                        <input type="checkbox" value="${codigo}" 
                            ${seleccionados.includes(codigo) ? 'checked' : ''}>
                        ${nombre}
                    </label>
                `;
                modalOpciones.appendChild(div);
            });
            
            modal.style.display = 'block';
        }

        // =======================
        // Guardar edición especial
        // =======================
        function guardarEdicionEspecial() {
            const checkboxes = modalOpciones.querySelectorAll('input[type="checkbox"]');
            const seleccionados = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    seleccionados.push(checkbox.value);
                }
            });
            
            // Actualizar códigos
            codigos[campoEditando] = seleccionados;
            
            // Traducir códigos a nombres para mostrar
            traducirCodigos(campoEditando === 'carreras' ? 'carreras' : 'materias', seleccionados.join(','))
                .then(nombres => {
                    datos[campoEditando] = nombres.join(", ");
                    renderPerfil();
                });
            
            modal.style.display = 'none';
        }

        // =======================
        // GET - Obtener datos del usuario
        // =======================
        async function obtenerDatosUsuario() {
            try {
                const response = await fetch(`${BASE_URL}/alumnos/${legajoUsuario}`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                });
                
                if (!response.ok) {
                    throw new Error("Error al obtener datos del usuario");
                }
                
                const rawData = await response.json();
                
                // Guardar los strings originales (separados por comas) para enviar al backend
                datos = rawData;
                
                // Guardar los códigos como arrays para su posible uso
                codigos.carreras = rawData.carreras ? rawData.carreras.split(',') : [];
                codigos.materiasCursa = rawData.materiasCursa ? rawData.materiasCursa.split(',') : [];
                codigos.materiasAprobadas = rawData.materiasAprobadas ? rawData.materiasAprobadas.split(',') : [];
                
                // Traducir códigos a nombres
                const [nombresCarreras, nombresMateriasCursa, nombresMateriasAprob] = await Promise.all([
                    traducirCodigos("carreras", rawData.carreras),
                    traducirCodigos("materias", rawData.materiasCursa),
                    traducirCodigos("materias", rawData.materiasAprobadas)
                ]);
                
                // Asignar los nombres traducidos a los datos para mostrar
                datos.carreras = nombresCarreras.join(", ");
                datos.materiasCursa = nombresMateriasCursa.join(", ");
                datos.materiasAprobadas = nombresMateriasAprob.join(", ");
                
                renderPerfil();
            } catch (error) {
                console.error(error);
                document.getElementById("datosUsuario").innerHTML = 
                    `<p class="error">Error al cargar el perfil: ${error.message}</p>`;
            }
        }

        // =======================
        // PUT - Guardar cambios en el backend
        // =======================
        async function guardarCambio(campo, nuevoValor) {
            // Crear objeto con todos los datos necesarios
            const datosActualizados = {
                ...datos,
                [campo]: nuevoValor.trim(),
                // Incluir el legajo (requerido por el backend)
                legajo: legajoUsuario,
                // Enviar los códigos como strings separados por comas
                carreras: codigos.carreras.join(','),
                materiasCursa: codigos.materiasCursa.join(','),
                materiasAprobadas: codigos.materiasAprobadas.join(',')
            };
            
            try {
                const response = await fetch(`${BASE_URL}/alumnos/${legajoUsuario}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(datosActualizados)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Error al actualizar en el servidor");
                }
                
                const data = await response.json();
                console.log("Perfil actualizado:", data);
                
                // Actualizar datos locales
                datos[campo] = nuevoValor.trim();
                renderPerfil();
                
            } catch (error) {
                console.error("Error al guardar cambios:", error);
                alert(`Error al guardar cambios: ${error.message}`);
            }
        }

        // =======================
        // DELETE - Eliminar usuario
        // =======================
        document.getElementById("eliminarPerfil").addEventListener("click", async () => {
            if (!confirm("¿Estás seguro de que deseas eliminar tu perfil? Esta acción no se puede deshacer.")) {
                return;
            }
            
            const contra = prompt("Por favor ingresa tu contraseña para confirmar:");
            if (!contra) return;
            
            try {
                const loginData = {
                    legajo: legajoUsuario,
                    contra: contra
                };
                
                const response = await fetch(`${BASE_URL}/usuarios/delete/${legajoUsuario}`, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(loginData)
                });
                
                if (!response.ok) {
                    if (response.status === 401) throw new Error("Contraseña incorrecta");
                    throw new Error("Error al eliminar el perfil");
                }
                
                alert("Tu perfil ha sido eliminado correctamente");
                localStorage.removeItem("legajo");
                window.location.href = "index.html";
                
            } catch (error) {
                console.error("Error al eliminar:", error);
                alert(`Error al eliminar el perfil: ${error.message}`);
            }
        });

        // =======================
        // Cargar datos al iniciar
        // =======================
        if (!legajoUsuario) {
            document.getElementById("datosUsuario").innerHTML = 
                `<p class="error">No se encontró información de usuario. Por favor inicia sesión.</p>`;
        } else {
            // Cargar opciones disponibles primero
            cargarOpcionesDisponibles().then(() => {
                obtenerDatosUsuario();
            });
        }

        // =======================
        // Eventos del modal
        // =======================
        modalGuardar.addEventListener('click', guardarEdicionEspecial);
        modalCancelar.addEventListener('click', () => modal.style.display = 'none');
        modalCerrar.addEventListener('click', () => modal.style.display = 'none');
        
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
</body>
</html>