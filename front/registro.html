<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Completar Perfil</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .materias-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 20px;
            margin-bottom: 15px;
        }
        .materias-list label {
            min-width: 220px;
            margin-bottom: 5px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Completar Perfil de Usuario</h2>
        <form id="perfilForm" class="active">
            <label for="nombre">Nombre</label>
            <input type="text" id="nombre" name="nombre" required>

            <label for="contraseña">Contraseña</label>
            <input type="password" id="contraseña" name="contraseña" required>

            <label for="fechaNacimiento">Fecha de nacimiento</label>
            <input type="date" id="fechaNacimiento" name="fechaNacimiento" required>

            <label for="dni">DNI</label>
            <input type="text" id="dni" name="dni" required>

            <label for="correoUni">Correo de la universidad</label>
            <input type="email" id="correoUni" name="correoUni" required>

            <label for="contacto">Datos de contacto (opcional)</label>
            <input type="text" id="contacto" name="contacto">

            <fieldset>
                <legend>Carrera</legend>
                <div id="carrerasContainer" class="materias-list">
                    <div class="loading">Cargando carreras...</div>
                </div>
            </fieldset>
            <br>

            <fieldset>
                <legend>Materias que cursa</legend>
                <div id="materiasCursaContainer" class="materias-list">
                    <div class="loading">Cargando materias...</div>
                </div>
            </fieldset>
            <br>

            <fieldset>
                <legend>Materias aprobadas</legend>
                <div id="materiasAprobadasContainer" class="materias-list">
                    <div class="loading">Cargando materias...</div>
                </div>
            </fieldset>
            <br>

            <button type="submit">Guardar Perfil</button>
        </form>
    </div>
    <script>
        // Obtener carreras y materias desde el backend
        async function cargarCarrerasYMatrias() {
            try {
                // Obtener todas las carreras
                const carrerasResponse = await fetch('http://localhost:8080/api/alumnos/all/carreras');
                if (!carrerasResponse.ok) throw new Error('Error cargando carreras');
                const carreras = await carrerasResponse.json();
                
                // Obtener todas las materias
                const materiasResponse = await fetch('http://localhost:8080/api/alumnos/all/materias');
                if (!materiasResponse.ok) throw new Error('Error cargando materias');
                const materias = await materiasResponse.json();
                
                // Renderizar carreras
                const carrerasContainer = document.getElementById('carrerasContainer');
                carrerasContainer.innerHTML = '';
                carreras.forEach(carrera => {
                    carrerasContainer.innerHTML += `
                        <label>
                            <input type="checkbox" name="carreras[]" value="${carrera.codigoCarrera}">
                            ${carrera.nombreCarrera}
                        </label>
                    `;
                });
                
                // Renderizar materias (para ambas secciones)
                const materiasCursaContainer = document.getElementById('materiasCursaContainer');
                const materiasAprobadasContainer = document.getElementById('materiasAprobadasContainer');
                
                materiasCursaContainer.innerHTML = '';
                materiasAprobadasContainer.innerHTML = '';
                
                materias.forEach(materia => {
                    const materiaHtml = `
                        <label>
                            <input type="checkbox" name="materiasCursa[]" value="${materia.codigoMateria}">
                            ${materia.nombreMateria}
                        </label>
                    `;
                    materiasCursaContainer.innerHTML += materiaHtml;
                    materiasAprobadasContainer.innerHTML += materiaHtml;
                });
                
            } catch (error) {
                console.error(error);
                document.getElementById('carrerasContainer').innerHTML = `Error: ${error.message}`;
                document.getElementById('materiasCursaContainer').innerHTML = `Error: ${error.message}`;
                document.getElementById('materiasAprobadasContainer').innerHTML = `Error: ${error.message}`;
            }
        }

        document.getElementById('perfilForm').onsubmit = function(e) {
            e.preventDefault();
            
            // Recolectar datos
            const formData = new FormData(this);
            const datos = {
                alumno: {
                    nombre: formData.get('nombre'),
                    dni: formData.get('dni'),
                    fechaNacimiento: formData.get('fechaNacimiento'),
                    contacto: formData.get('contacto'),
                    correoUni: formData.get('correoUni'),
                    // Enviar como string separado por comas
                    carreras: formData.getAll('carreras[]').join(','),
                    materiasCursa: formData.getAll('materiasCursa[]').join(','),
                    materiasAprobadas: formData.getAll('materiasAprobadas[]').join(',')
                },
                contra: formData.get('contraseña')
            };

            // Enviar al backend
            fetch('http://localhost:8080/api/usuarios/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            })
            .then(response => {
                if (response.status === 400) throw new Error('Usuario ya existe');
                if (!response.ok) throw new Error('Error en el registro');
                return response.json();
            })
            .then(data => {
                localStorage.setItem('legajo', data.alumno.legajo);
                window.location.href = "perfil.html";
            })
            .catch(err => alert('Error: ' + err.message));
        };

        // Cargar carreras y materias al iniciar
        cargarCarrerasYMatrias();
    </script>
</body>
</html>